<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Archivos DICOM - {{ usuario }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
</head>
<body>
    <div class="container mt-4">
        <h2>Archivos DICOM - Usuario: {{ usuario }} (Rol: {{ rol }})</h2>
        <a href="{{ url_for('logout') }}" class="btn btn-danger mb-3">Cerrar sesión</a>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="alert alert-info">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}
        {% endwith %}

        {% if rol in ['doctor', 'clinica'] %}
        <form action="{{ url_for('index') }}" method="post" enctype="multipart/form-data" class="mb-4">
            <div class="form-group">
                <label for="archivos">Subir uno o más archivos DICOM (.dcm):</label>
                <input type="file" class="form-control-file" id="archivos" name="archivos" accept=".dcm" multiple required>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Subir archivos</button>
        </form>
        {% endif %}

        {% if archivos %}
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Paciente (PatientName)</th>
                    <th>PatientID</th>
                    <th>Fecha de subida (UTC)</th>
                    <th>Subido por</th>
                    <th>Nombre</th>
                    <th>Descargar</th>
                    <th>Ver detalles</th>
                    {% if rol in ['doctor', 'clinica'] %}
                    <th>Eliminar</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for archivo in archivos %}
                <tr>
                    <td>{{ archivo.paciente }}</td>
                    <td>{{ archivo.patient_id if archivo.patient_id else 'Desconocido' }}</td>
                    <td>{{ archivo.fecha.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ archivo.usuario }}</td>
                    <td>{{ archivo.nombre }}</td>
                    <td><a href="{{ url_for('descargar', filename=archivo.nombre) }}" class="btn btn-sm btn-success">Descargar</a></td>
                    <td><a href="{{ url_for('ver', filename=archivo.nombre) }}" class="btn btn-sm btn-info">Ver detalles</a></td>
                    {% if rol in ['doctor', 'clinica'] %}
                    <td>
                        <form action="{{ url_for('eliminar_archivo', filename=archivo.nombre) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Seguro que quieres eliminar este archivo?');">Eliminar</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No hay archivos subidos todavía.</p>
        {% endif %}
    </div>
</body>
</html>
